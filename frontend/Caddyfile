(inttls) {
    tls /certs/aiectomy.xyz/fullchain.cer /certs/aiectomy.xyz/aiectomy.xyz.key
}

(habits-backend) {
    @metrics path /metrics
    handle @metrics {
        reverse_proxy http://habits-server:3000
    }
    @health path /healthz /readyz /version
    handle @health {
        reverse_proxy http://habits-server:3000
    }
    @auth path /auth/*
    handle @auth {
        reverse_proxy http://habits-server:3000
    }
    @api path /api/*
    handle @api {
        uri strip_prefix /api
        reverse_proxy http://habits-server:3000
    }
}

(habits-frontend) {
    handle {
        root * /usr/share/caddy
        encode zstd gzip
        try_files {path} /index.html
        file_server
    }
}

habits.aiectomy.xyz {
    import inttls
    import habits-backend
    import habits-frontend
}

idm.aiectomy.xyz {
    import inttls
    reverse_proxy idm.aiectomy.xyz:8443 {
        transport http {
                tls
                tls_insecure_skip_verify
        }
    }
}
